<%#
LuCI - Lua Configuration Interface
Copyright 2008 Steven Barth <steven@midlink.org>
Copyright 2008-2011 Jo-Philipp Wich <xm@subsignal.org>

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

$Id: index.htm 7810 2011-10-28 15:15:27Z jow $

-%>
<%
	local device = require "luci.tools.device"
%>

<%+header%>
<h2>
<a id="content" name="content">设备列表</a>
</h2>
<table class="cbi-section-table">
	<colgroup></colgroup>
	<colgroup style="width:150px"></colgroup>
	<tr>
		<th>设备名称</th>
		<th><div class="text-center">互联网访问</div></th>
	</tr>
	<%for _, e in ipairs(device:list()) do%>
		<tr>
			<td>
				<div class="media">
					<input class="macvalue" type="hidden" value="<%=e.macaddr:upper()%>" />
					<img src="<%=resource%>/img/brand/<%=e.brand%>.png" style="width:75px;height:75px" class="ico-brand pull-left" />
					<div class="media-body">
						<div class="media-heading"><strong class="remark"><%if e.remark == "" then write(e.hostname) else write(e.remark) end%></strong> <a href="#remarkModal" data-toggle="modal" class="btn btn-mini">备注</a></div>
						<p>
							<small>MAC 地址：<a href="http://mac.51240.com/<%=e.macaddr%>__mac/" target="_blank" class="mac"><%=e.macaddr:upper()%></a></small> | 
							<small>IP 地址：<%=e.ipaddr%></a></small>
						</p>
						<p>
							<small>连接方式：<% if e.conntype == "cable" then write("有线") else write("无线") end%></small> |
							<small>状态：<%if e.isonline then write("在线") else write("离线") end %></small>
						</p>
					</div>
				</div>
			</td>
			<td style="vertical-align:middle">
				<div class="text-center">
					<button type="button" class="btn-enable-wan btn btn-danger btn-small"><i class="icon icon-remove icon-white"></i> 断开连接</button>
				</div>
			</td>
		</tr>
	<% end %>
</table>
<div id="remarkModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="remarkModalLabel" aria-hidden="true">
  <div class="modal-header">
	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	<div id="remarkModalLabel">修改备注</div>
  </div>
  <div class="modal-body">
	<p>
		<input id="macaddr" name="macaddr" type="text" class="input-block-level" placeholder="MAC 地址" />
	</p>
	<p>
		<input id="remark" name="remark" type="text" class="input-block-level" placeholder="备注" />
	</p>
  </div>
  <div class="modal-footer">
	<button id="btnRemark" class="btn btn-primary">保存</button>
	<button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
  </div>
</div>
<script type="text/javascript">
	$(function(){
		$(".mac").each(function(){
			var item = $(this);
			var mac = $(this).text();
			jQuery.getJSON("http://wifi.iwoi.cn/mac/details?mac=" + mac + "&callback=?", function(data) {
				if (data.state.logo){
					item.parent().parent().parent().parent().find("img").attr("src", data.state.logo);
				}
			}); 
		});
					
		$("#btnRemark").click(function(){
			$.post("<%=luci.dispatcher.build_url("admin/device/remark")%>", { macaddr : $("#macaddr").val(), remark : $("#remark").val() }, function(result){
				$(".macvalue").each(function(){
					if ($(this).val() == result.state.macaddr){
						$(this).parent().find(".remark").text(result.state.remark);
					}
				});
				$("#remarkModal").modal("hide");
			});
		});
		
		$(".btn-enable-wan").click(function(){
			if (confirm("确认要断开该链接吗？")){
			}
		});
	})
</script>
<%+footer%>
